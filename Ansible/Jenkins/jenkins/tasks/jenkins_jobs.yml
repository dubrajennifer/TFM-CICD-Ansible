- name: Copy STG pipeline job to temporary directory
  copy:
    src: "../templates/STG-pipeline_job.xml"
    dest: "/tmp/STG-pipeline_job.xml"
  delegate_to: localhost
  run_once: true

- name: Copy PRD pipeline job to temporary directory
  copy:
    src: "../templates/PRD-pipeline_job.xml"
    dest: "/tmp/PRD-pipeline_job.xml"
  delegate_to: localhost
  run_once: true

- name: Copy STG pipeline template to temporary directory
  copy:
    src: "../templates/STG-generic_pipeline.groovy"
    dest: "/tmp/STG-generic_pipeline.groovy"
  delegate_to: localhost
  run_once: true

- name: Copy PRD pipeline template to temporary directory
  copy:
    src: "../templates/PRD-generic_pipeline.groovy"
    dest: "/tmp/PRD-generic_pipeline.groovy"

- name: Read DSL script
  slurp:
    src: "/tmp/PRD-generic_pipeline.groovy"
  register: dsl_script

- name: Convert DSL script to string
  set_fact:
    dsl_script_string: "{{ dsl_script.content | b64decode | string }}"

- name: Create Jenkins job using REST API
  uri:
    method: POST
    url_username: "{{ jenkins_admin_username }}"
    url_password: "{{ jenkins_admin_password }}"
    url: "http://localhost:8080/createItem?name=STG-pipeline"
    body: "{{ dsl_script_string }}"
    body_format: text/plain
    return_content: yes
  register: job_creation_result

- name: Print job creation result
  debug:
    var: job_creation_result.content
